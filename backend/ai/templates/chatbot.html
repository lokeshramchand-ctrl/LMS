{% extends 'base.html' %}

{% block styles %}
<style>
    body, html {
        height: 100%;
    }

    .messages-box {
        flex: 1;
        overflow-y: auto;
    }

    .messages-list {
        padding-left: 0;
    }

    .message {
        margin-bottom: 15px;
        list-style: none;
    }

    .message-text {
        padding: 10px;
        border-radius: 5px;
    }

    .sent {
        background-color: #dcf8c6;
        align-self: flex-end;
    }

    .received {
        background-color: #f1f0f0;
        align-self: flex-start;
    }

    .message-form {
        display: flex;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 10px;
        background-color: #f8f9fa;
    }

    .message-input {
        flex: 1;
        border-radius: 0;
        border-right: none;
    }

    .btn-send {
        border-radius: 0;
    }

    .chat-container {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="card flex-grow-1">
        <div class="card-header bg-primary text-white">Chat</div>
        <div class="card-body messages-box">
            <ul class="list-unstyled messages-list" id="chat-messages">
                <li class="message received">
                    <div class="message-text">
                        <b>AI Chatbot</b>
                        <div class="message-content">Hi, I am your AI Chatbot, you can ask me anything.</div>
                    </div>
                </li>
                {% for chat in chats %}
                <li class="message sent">
                    <div class="message-text">
                        <b>You</b>
                        <div class="message-content">{{ chat.message }}</div>
                    </div>
                </li>
                <li class="message received">
                    <div class="message-text">
                        <b>AI Chatbot</b>
                        <div class="message-content">{{ chat.response }}</div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <form id="chat-form" class="message-form">
        {% csrf_token %}
        <div class="input-group">
            <input type="text" class="form-control message-input" name="message" id="message-input" placeholder="Type your message..." required>
            <div class="input-group-append">
                <button type="submit" class="btn btn-primary btn-send">Send</button>
            </div>
        </div>
    </form>
</div>

<script>
document.getElementById("chat-form").addEventListener("submit", function(event) {
    event.preventDefault(); // Prevent form submission

    let messageInput = document.getElementById("message-input");
    let message = messageInput.value.trim();
    if (!message) return; // Ignore empty messages

    let chatMessages = document.getElementById("chat-messages");

    // Append user's message
    let userMessage = document.createElement("li");
    userMessage.classList.add("message", "sent");
    userMessage.innerHTML = `<div class="message-text"><b>You</b><div class="message-content">${message}</div></div>`;
    chatMessages.appendChild(userMessage);

    // Clear input field
    messageInput.value = "";

    // Send message to Django
    fetch("", {
        method: "POST",
        headers: {
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: `message=${encodeURIComponent(message)}`,
    })
    .then(response => response.json())
    .then(data => {
        let botMessage = document.createElement("li");
        botMessage.classList.add("message", "received");
        botMessage.innerHTML = `<div class="message-text"><b>AI Chatbot</b><div class="message-content">${data.response}</div></div>`;
        chatMessages.appendChild(botMessage);

        // Scroll to the bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
    })
    .catch(error => console.error("Error:", error));
});
</script>
{% endblock %}
